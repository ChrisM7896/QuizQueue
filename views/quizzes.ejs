<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quizzes</title>
    <style>
        form {
            border: 1px solid black;
            margin: 10px;
            padding: 10px;
        }

        #quizDetails {
            display: none;
        }
    </style>
</head>

<body>
    <form action="/addQuiz" method="POST">
        <h1>Create a new Quiz:</h1>
        <label for="quizTitle">Quiz Title:</label>
        <input type="text" id="quizTitle" name="quizName" placeholder="Quiz Title">
        <button type="submit">Create Quiz</button>
    </form>
    <br>

    <form id="quizSelectionForm" onsubmit="editQuiz(event)">
        <h1>Edit a Quiz:</h1>
        <label for="quizSelection">Select a Quiz to Edit:</label>
        <select id="quizSelection" name="quizSelection">
            <option value="" disabled selected>Select a quiz</option>
        </select>
        <button type="submit">Edit Quiz</button>
    </form>
    <br>

    <div id="quizDetails">
        <h1 id="quizDetailsTitle">Displaying Quiz: </h1>

        <button id="previewQuestionsButton" onclick="previewQuestions()">Preview Questions</button>
        <button id="changeQuizNameButton">Change Quiz Name</button>
        <button id="addQuestionButton">Add a Question</button>

        <div id="previewQuestionsDiv"></div>

        <form id="changeQuizNameForm" onsubmit="changeQuizName(event)">
            <h2>Change Quiz Name:</h2>
            <input type="text" id="newQuizName" name="newQuizName" placeholder="Enter new quiz name here">
            <button type="submit">Change Quiz Name</button>
        </form>

        <form id="addQuestionForm" action="/addQuestion" method="GET">
            <h2>Add a Question:</h2>
            <input type="text" id="addQuestion" name="addQuestion" placeholder="Enter question here"> <br> <br>

            <input type="text" id="answers1" name="answer1" placeholder="Enter answer here(Required)"> <br>
            <input type="text" id="answers2" name="answer2" placeholder="Enter answer here(Required)"> <br>
            <input type="text" id="answers3" name="answer3" placeholder="Enter answer here(Optional)"> <br>
            <input type="text" id="answers4" name="answer4" placeholder="Enter answer here(Optional)"> <br>
            <button type="submit" onclick="addQuestion()">Submit</button>
        </form>
    </div>

    <br>
    <br>

</body>

<script>
    // assign elements to variables
    const quizSelection = document.getElementById('quizSelection');
    const quizDetails = document.getElementById('quizDetails');
    const quizDetailsTitle = document.getElementById('quizDetailsTitle');
    const previewQuestionsDiv = document.getElementById('previewQuestionsDiv');
    const editQuizButton = document.querySelector('form[action="/editQuiz"] button');
    const newQuizName = document.getElementById('newQuizName').value;

    // parse quizzes data from server
    const quizzes = `<%- JSON.stringify(quizzes) %>`;

    document.addEventListener('DOMContentLoaded', () => {
        const parsedQuizzes = JSON.parse(quizzes); // Parse the quizzes string
        updateQuizList(parsedQuizzes);
    });

    // update quiz list and selection dropdown
    function updateQuizList(quizzes) {
        quizSelection.innerHTML = '<option value="" disabled selected>Select a quiz</option>';

        quizzes.forEach(quiz => {
            const quizOpt = document.createElement('option');
            quizOpt.value = quiz.quizID
            quizOpt.textContent = quiz.quizName;
            quizSelection.appendChild(quizOpt);
        });
    };

    function previewQuestions() {
        const quizID = quizSelection.value;
        if (!quizID) {
            alert('Please select a quiz to preview questions.');
            return;
        }

        console.log('Selected Quiz ID:', quizID); // Debugging log

        fetch(`/getQuestions?quizID=${quizID}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text(); // Read the response as plain text first
            })
            .then(text => {
                try {
                    const data = JSON.parse(text); // Parse the text as JSON
                    if (!data || data.length === 0) {
                        alert('No questions found for the selected quiz.');
                        return;
                    }
                    console.log('Fetched Questions:', data); // Debugging log
                    displayQuestions(data);
                } catch (error) {
                    console.error('Error parsing JSON:', error);
                    alert('Invalid response from the server.');
                }
            })
            .catch(error => {
                console.error('Error fetching questions:', error);
                alert('Error fetching questions. Please try again later.');
            });
    }

    function editQuiz(event) {
        event.preventDefault();
        if (!quizSelection.value) {
            alert('Please select a quiz to edit.');
            return;
        }

        quizDetails.style.display = 'block';
        quizDetailsTitle.textContent = `Displaying Quiz: ${quizSelection.options[quizSelection.selectedIndex].text}`;
        previewQuestions();
    }

</script>

</html>